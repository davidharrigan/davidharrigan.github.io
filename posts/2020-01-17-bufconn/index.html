<!doctype html><html data-theme=night lang=en-us dir=ltr class=scroll-smooth><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Testing Go gRPC Server Using an in-memory Buffer with `bufconn` | harrigan.xyz</title>
<link href=https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css rel=stylesheet><link rel=stylesheet href=/css/main.min.c8ab1dbf142ff1a7aaf28c9f420facadb18cc51928da7fd4c0bcfbadaa2fe7af.css integrity="sha256-yKsdvxQv8aeq8oyfQg+srbGMxRko2n/UwLz7raov568=" crossorigin=anonymous><script defer src=/js/main.399f36bf66ff811bab5a2140358e94beb4621123d78fb560822ececb0594fd95.js integrity="sha256-OZ82v2b/gRurWiFANY6UvrRiESPXj7Vggi7OywWU/ZU=" crossorigin=anonymous></script></head><body><div class=drawer x-data x-bind=keyboard><input id=sidebar type=checkbox class=drawer-toggle x-model=$store.sidebar.open><div class=drawer-content><div class="navbar bg-base-100 z-30"><div class=flex-none><div class="tooltip tooltip-bottom" data-tip=⌘E><label for=sidebar aria-label="open sidebar" class="btn btn-square btn-ghost"><i class="bx bx-menu-alt-left bx-sm"></i></label></div></div><div class=flex-1><a class="btn btn-ghost text-xl" href=/>harrigan.xyz</a></div><div class="absolute m-auto left-1/4 w-1/2 hidden"><label class="searchbox relative w-full"><i class="bx bx-search absolute my-4 ms-4 opacity-40 text-base-content"></i><div class=flex-1><input type=text placeholder=Search name=search class="input input-bordered ps-10 w-full" x-ref=search autocomplete=off></div><div class="pointer-events-none absolute end-6 top-2.5 gap-1 opacity-50 rtl:flex-row-reverse md:block hidden"><kbd class="kbd kbd-sm">⌘</kbd>
<kbd class="kbd kbd-sm">K</kbd></div></label></div><div class="flex-none pr-4"><label class="swap swap-rotate"><input type=checkbox class="theme-controller hidden" value=retro x-data=theme x-model=light x-on:click=toggle()><svg class="swap-on fill-current w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 24"><path d="M5.64 17l-.71.71a1 1 0 000 1.41 1 1 0 001.41.0l.71-.71A1 1 0 005.64 17zM5 12a1 1 0 00-1-1H3a1 1 0 000 2H4a1 1 0 001-1zm7-7a1 1 0 001-1V3a1 1 0 00-2 0V4a1 1 0 001 1zM5.64 7.05a1 1 0 00.7.29 1 1 0 00.71-.29 1 1 0 000-1.41l-.71-.71A1 1 0 004.93 6.34zm12 .29a1 1 0 00.7-.29l.71-.71a1 1 0 10-1.41-1.41L17 5.64a1 1 0 000 1.41 1 1 0 00.66.29zM21 11H20a1 1 0 000 2h1a1 1 0 000-2zm-9 8a1 1 0 00-1 1v1a1 1 0 002 0V20a1 1 0 00-1-1zm6.36-2A1 1 0 0017 18.36l.71.71a1 1 0 001.41.0 1 1 0 000-1.41zM12 6.5A5.5 5.5.0 1017.5 12 5.51 5.51.0 0012 6.5zm0 9A3.5 3.5.0 1115.5 12 3.5 3.5.0 0112 15.5z"/></svg><svg class="swap-off fill-current w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.64 13a1 1 0 00-1.05-.14 8.05 8.05.0 01-3.37.73A8.15 8.15.0 019.08 5.49a8.59 8.59.0 01.25-2A1 1 0 008 2.36 10.14 10.14.0 1022 14.05 1 1 0 0021.64 13zm-9.5 6.69A8.14 8.14.0 017.08 5.22v.27A10.15 10.15.0 0017.22 15.63a9.79 9.79.0 002.1-.22 8.11 8.11.0 01-7.18 4.32z"/></svg></label></div></div><div class="mx-auto max-w-screen-lg min-h-screen px-3 py-6"><article class="prose mx-auto py-6"><h1 class=tracking-tight>Testing Go gRPC Server Using an in-memory Buffer with `bufconn`</h1><div class="pb-2 text-base-content/50 text-sm"><time datetime=2020-01-17T00:00:00+00:00>Jan 17, 2020</time>
<span>·</span>
<span>3 min</span></div><div class="flex flex-wrap"><a class="mr-3 text-sm font-medium uppercase link link-accent" href=/tags/go>go</a>
<a class="mr-3 text-sm font-medium uppercase link link-accent" href=/tags/development>development</a>
<a class="mr-3 text-sm font-medium uppercase link link-accent" href=/tags/testing>testing</a></div><div class=divider></div><p><p>It can be cumbersome to setup a testing environment targeting a live server
to implement full API testing against your gRPC server. Even spinning up a
server from your test file can lead to unintended consequences that require
you to allocate a TCP port (parallel runs, multiple runs under same CI
server).</p><p><a href=https://godoc.org/google.golang.org/grpc/test/bufconn>bufconn</a> is a package
which provides a <code>Listener</code> object that implements <code>net.Conn</code>. We can
substitute this listener in a gRPC server - allowing us to spin up a server
that acts as a full-fledged server that can be used for testing that talks
over an in-memory buffer instead of a real port.</p><h2 id=goals>Goals</h2><ul><li>Spin up a gRPC server using an in-memory buffer</li><li>Use the server in a standard <code>testing.Test</code> test function</li></ul><h2 id=setup>Setup</h2><p>Same as my other post, I created a simple gRPC service that implements <code>Ping</code>
and <code>StreamPring</code>. Calling <code>Ping</code> replies with (you guessed it!) a
<code>pong</code> message. <code>StreamPing</code> is similar, but you can specify how many times
it <code>pong</code>&rsquo;s back.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span>syntax <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;proto3&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>package</span> ping;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>option</span> go_package <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;protos&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>service</span> Pinger {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>rpc</span> Ping(PingRequest) <span style=color:#66d9ef>returns</span> (PingResponse) {}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>rpc</span> PingStream (PingRequest) <span style=color:#66d9ef>returns</span> (stream PingResponse) {}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>PingRequest</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>int32</span> count <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>PingResponse</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>bytes</span> payload <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=using-bufconn>Using <code>bufconn</code></h2><p>To easily spin up a server and a client that talk over a <code>bufconn</code> buffer,
I created a function that is called by the test file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>server</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>PingerClient</span>, <span style=color:#66d9ef>func</span>()) {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>buffer</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>listener</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufconn</span>.<span style=color:#a6e22e>Listen</span>(<span style=color:#a6e22e>buffer</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>NewServer</span>()
</span></span><span style=display:flex><span> <span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>RegisterPingerServer</span>(<span style=color:#a6e22e>s</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Pinger</span>{})
</span></span><span style=display:flex><span> <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Serve</span>(<span style=color:#a6e22e>listener</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>   panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span> }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>DialContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithContextDialer</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Conn</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>listener</span>.<span style=color:#a6e22e>Dial</span>()
</span></span><span style=display:flex><span> }), <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithInsecure</span>(), <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithBlock</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>NewPingerClient</span>(<span style=color:#a6e22e>conn</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Stop</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Important thing to note here are, this function:</p><ul><li>Spins up gRPC server using the bufconn buffer</li><li>Creates a client that talks over the buffer using <code>gRPC.WithContextDialer</code></li><li>Returns function to terminate the listener and the server</li></ul><h2 id=using-the-bufconn-client>Using the <code>bufconn</code> client</h2><p>With the above function, the rest are easy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>assert</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>closer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>server</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>closer</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>out</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Ping</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>tc</span>.<span style=color:#a6e22e>in</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tc</span>.<span style=color:#a6e22e>expected</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>tc</span>.<span style=color:#a6e22e>expected</span>.<span style=color:#a6e22e>out</span>, <span style=color:#a6e22e>out</span>)
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>out</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>tc</span>.<span style=color:#a6e22e>expected</span>.<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That is the meat of my test. It uses the <code>server</code> function, after making sure
the <code>closer</code> is defered, it uses the client to make a request. The response
is asserted against expectation. This all happens against a gRPC server,
except it uses <code>bufconn</code> instead of a TCP socket.</p><p>Source code for the full setup is available
<a href=https://github.com/davidharrigan/bufconn-test>here</a>.</p><h3 id=conclusion>Conclusion</h3><p><code>bufconn</code> allows you to spin up a gRPC server that talk over an in-memory
buffer. Tests are fast and reliable, and allows you to easily setup
integration style tests that uses a full server.</p></p></article></div><footer class="footer footer-center p-4 bg-base-300 text-base-content"><aside><p>Copyright 2024. All rights reserved.</p></aside></footer></div><div class="drawer-side z-10" style=scroll-behavior:smooth;scroll-padding-top:5rem><label for=sidebar aria-label="close sidebar" class=drawer-overlay></label><aside class="min-h-screen w-80 bg-base-200"><div class=navbar><div class=flex-1><a class="btn btn-ghost text-xl" href=/>harrigan.xyz</a></div><div class=flex-none><div class="tooltip tooltip-bottom" data-tip=⌘E><label for=sidebar aria-label="open sidebar" class="btn btn-square btn-ghost"><i class="bx bx-x bx-sm bx-tada-hover"></i></label></div></div></div><ul class="menu p-4"><li><a href=/posts><i class="bx bx-note bx-sm"></i>Latest Posts</a></li><li></li><li><details><summary><i class="bx bx-purchase-tag bx-sm text-accent"></i>Tags</summary><ul><li><a href=/tags/development/ title="All pages with tag <i>development</i>">development
<sup>2</sup></a></li><li><a href=/tags/go/ title="All pages with tag <i>go</i>">go
<sup>2</sup></a></li><li><a href=/tags/testing/ title="All pages with tag <i>testing</i>">testing
<sup>2</sup></a></li></ul></details></li><li></li><li><a href=https://github.com/davidharrigan><i class="bx bxl-github bx-sm"></i>Github</a></li><li><a href=https://www.linkedin.com/in/david-t-harrigan><i class="bx bxl-linkedin bx-sm"></i>Linkedin</a></li></ul></aside></div></div></body></html>