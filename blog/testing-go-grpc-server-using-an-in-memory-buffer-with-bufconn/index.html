<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Don't panic"><meta property="twitter:site" content="@DavidTHarrigan"><meta property="og:site_name" content="David Harrigan"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="og:url" content="https://harrigan.xyz/blog/testing-go-grpc-server-using-an-in-memory-buffer-with-bufconn/"><meta property="og:title" content="Testing Go gRPC Server Using an in-memory Buffer with `bufconn`"><meta property="twitter:title" content="Testing Go gRPC Server Using an in-memory Buffer with `bufconn`"><meta property="twitter:card" content="summary"><meta property="og:description" content="Testing Go gRPC Server Using an in-memory Buffer with `bufconn`"><meta property="twitter:description" content="Testing Go gRPC Server Using an in-memory Buffer with `bufconn`"><title>David Harrigan - Testing Go gRPC Server Using an in-memory Buffer with `bufconn`</title><link rel=canonical href=https://harrigan.xyz/blog/testing-go-grpc-server-using-an-in-memory-buffer-with-bufconn/><style media=screen>@font-face{font-family:nexa bold;src:url('https://harrigan.xyz/fonts/Nexa Bold.otf')}html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,ruby,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section,div.column{display:block}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}*,*:before,*:after{box-sizing:border-box}a,a:visited,a:focus,a:active{text-decoration:none}html{height:100%;font-size:16px}body{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:column;-moz-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;-webkit-justify-content:flex-start;-moz-justify-content:flex-start;-ms-justify-content:flex-start;justify-content:flex-start;width:100%;min-height:100%;font-weight:400;font-family:helvetica neue,arial,sans-serif;color:#111;line-height:1.6;text-rendering:optimizeLegibility!important}.icon{text-rendering:geometricPrecision!important}section{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-justify-content:center;-moz-justify-content:center;-ms-justify-content:center;justify-content:center;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;width:100%}div.column{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-justify-content:center;-moz-justify-content:center;-ms-justify-content:center;justify-content:center;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;width:100%}.container{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;width:100%}div.header .container{-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;-webkit-justify-content:center;-moz-justify-content:center;-ms-justify-content:center;justify-content:center}div.header .content{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:column;-moz-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center}div.header .container .logo{max-width:100px;margin-left:-2em}div.header .name{padding-top:20px;font-size:28px;font-family:nexa bold,helvetica neue,arial,sans-serif;letter-spacing:-.005rem;text-transform:uppercase;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-smoothing:antialiased;color:#333}div.header nav{margin-bottom:16px}div.header nav ul{list-style:none;text-align:center;display:-webkit-inline-flex;display:-moz-inline-flex;display:-ms-inline-flexbox;display:-ms-inline-flex;display:inline-flex}div.header nav ul li{margin-left:6px;margin-right:6px}div.header nav ul li:first-child{margin-left:0}div.header nav ul li:last-child{margin-right:0}div.header nav ul a{color:#555;font-weight:400;font-size:14px;text-transform:uppercase;font-family:helvetica neue,arial,sans-serif;-webkit-transition:color .1s cubic-bezier(.47,0,.75,.72);-moz-transition:color .1s cubic-bezier(.47,0,.75,.72);-ms-transition:color .1s cubic-bezier(.47,0,.75,.72);-o-transition:color .1s cubic-bezier(.47,0,.75,.72)}div.header nav ul a:hover{color:#111}div.footer .container{-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;-webkit-justify-content:center;-moz-justify-content:center;-ms-justify-content:center;justify-content:center;flex-direction:column-reverse;width:100%;text-align:center}div.footer .container a{font-size:14px;margin-left:6px;margin-right:6px;opacity:.6;-webkit-transition:opacity .1s cubic-bezier(.47,0,.75,.72);-moz-transition:opacity .1s cubic-bezier(.47,0,.75,.72);-ms-transition:opacity .1s cubic-bezier(.47,0,.75,.72);-o-transition:opacity .1s cubic-bezier(.47,0,.75,.72)}div.footer .container a:first-child{margin-left:0}div.footer .container a:last-child{margin-right:0}div.footer .container a:hover{opacity:.8}div.footer .container a .icon{width:16px;height:16px}div.footer .container .copyright{flex-grow:.5;text-align:start}div.footer .container .icons{flex-grow:.5;text-align:end}div.main .container{-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;-webkit-justify-content:flex-start;-moz-justify-content:flex-start;-ms-justify-content:flex-start;justify-content:flex-start}div.main .content{color:#111;font-size:16px}div.main .content .title-container{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-justify-content:space-between;-moz-justify-content:space-between;-ms-justify-content:space-between;justify-content:space-between}div.main .content .posts{}div.main .content .page-heading{font-size:20px;font-weight:700;font-family:helvetica neue,arial,sans-serif;letter-spacing:-.005rem;text-transform:uppercase;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-smoothing:antialiased;color:#333;margin-bottom:16px}div.main .content .front-matter .page-heading{margin-bottom:0}div.main .content .front-matter .meta{font-size:14px;color:#666;display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;margin-bottom:32px}div.main .content .front-matter .date,div.main .content .front-matter .author,div.main .content .front-matter .tags,div.main .content .front-matter .word-count,div.main .content .front-matter .middot:before{display:none}div.main .content .front-matter .middot:before{font-size:6px;margin:0 6px;vertical-align:middle;content:"•"}div.main .content .front-matter .tags ul{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:row;-moz-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center}div.main .content .front-matter .tags ul li{-webkit-transition:opacity .1s cubic-bezier(.47,0,.75,.72);-moz-transition:opacity .1s cubic-bezier(.47,0,.75,.72);-ms-transition:opacity .1s cubic-bezier(.47,0,.75,.72);-o-transition:opacity .1s cubic-bezier(.47,0,.75,.72)}div.main .content .front-matter .tags ul li:hover{opacity:.7}div.main .content .front-matter .tags ul li a{color:#666}div.main .container.f04{-webkit-justify-content:center;-moz-justify-content:center;-ms-justify-content:center;justify-content:center}div.main .container.f04 .content{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:column;-moz-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center}div.main .container.f04 .content .num{margin:30px 0 30px 0;font-weight:400;font-family:helvetica neue,arial,sans-serif;font-size:50px}div.main .container.f04 .content .detail{margin-bottom:40px}div.main .container .content .groupby{margin-top:1em;padding-left:.5em}div.main .container .content .post-item{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;display:list-item;list-style:disc inside}div.main .container .content .post-item .meta{font-size:14px;color:#666;display:none;min-width:100px}div.main .container .content .see-more{font-style:italic;float:right;font-size:.9em;margin-top:2em;color:#313537}div.main .container .content .see-more:hover{color:#666}section{padding:0 16px}div.column{padding:0 16px}div.header{padding-top:10px}div.header-home{padding-top:36px}div.main{padding-top:32px}div.main .container .content .post-item .meta{display:block}div.main .container .content .post-item{display:flex;list-style:none}a{color:#428bca;-webkit-transition:color .1s cubic-bezier(.47,0,.75,.72);-moz-transition:color .1s cubic-bezier(.47,0,.75,.72);-ms-transition:color .1s cubic-bezier(.47,0,.75,.72);-o-transition:color .1s cubic-bezier(.47,0,.75,.72)}a:hover{color:#2a6496}img{max-width:100%}div.main .content{width:100%}div.main .content .markdown{font-size:1.1em;line-height:1.75em;color:#313537;font-family:serif;font-weight:300}div.main .content .markdown h1,div.main .content .markdown h2,div.main .content .markdown h3,div.main .content .markdown h4,div.main .content .markdown h5,div.main .content .markdown h6{font-size:22px;font-family:helvetica neue,arial,sans-serif;letter-spacing:-.005rem;font-weight:700;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-smoothing:antialiased;color:#333;text-transform:none;margin-top:1.75rem}div.main .content .markdown h1{font-size:1.75rem;margin-bottom:2rem}div.main .content .markdown h2{font-size:1.5rem;margin-bottom:1.5rem}div.main .content .markdown h3{font-size:1em;margin-bottom:1rem}div.main .content .markdown h4,div.main .content .markdown h5,div.main .content .markdown h6{font-size:1rem;margin-bottom:1rem;letter-spacing:none}div.main .content .markdown code,div.main .content .markdown pre{font-family:menlo,monospace;font-size:.98rem;background-color:#f7f7f7}div.main .content .markdown code{padding:.15em .5em;border-radius:2px}div.main .content .markdown pre{display:block;margin-top:1rem;margin-bottom:2rem;padding:1rem;line-height:1.5em;white-space:pre;word-break:break-all;word-wrap:break-word}div.main .content .markdown pre code{padding:0;font-size:.9rem}div.main .content .markdown a code{color:#428bca!important}div.main .content .markdown a code:hover{text-decoration:underline}div.main .content .markdown p{text-align:justify;margin-top:0;margin-bottom:1em}div.main .content .markdown ul,div.main .content .markdown ol,div.main .content .markdown dl{margin-top:1rem;margin-bottom:2rem}div.main .content .markdown dt{font-weight:700}div.main .content .markdown dd{margin-bottom:.5rem}div.main .content .markdown ul{list-style-type:disc;list-style-position:outside;margin-bottom:1.25rem}div.main .content .markdown ol{list-style-type:decimal;margin-bottom:1.25rem}div.main .content .markdown li{margin-left:2em}div.main .content .markdown em{font-style:italic}div.main .content .markdown strong{font-weight:700}div.main .content .markdown hr{position:relative;margin:1.75rem 0;border:0;border-top:1px solid gray;border-top:1px solid #999}div.main .content .markdown abbr{font-size:.85rem;font-weight:700;color:#666;text-transform:uppercase}div.main .content .markdown abbr[title]{cursor:help;border-bottom:1px dotted gray}div.main .content .markdown blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}div.main .content .markdown blockquote p:last-child{margin-bottom:0}div.main .content .markdown figure{width:100%;background:#fff;margin-bottom:1em}div.main .content .markdown figure img{width:100%;height:auto;max-width:100%;display:block;position:static;margin:auto}div.main .content .markdown table{margin-bottom:1rem;width:100%;border:1px solid #e5e5e5;border-collapse:collapse}div.main .content .markdown td,div.main .content .markdown th{padding:.25rem .5rem;border:1px solid #e5e5e5}div.main .content .markdown tbody tr:nth-child(odd) td,div.main .content .markdown tbody tr:nth-child(odd) th{background-color:#f7f7f7}div.main .content .markdown .footnotes ol{list-style-type:decimal;margin-left:16px}div.main .content .markdown .footnotes li{list-style-type:unset}div.main .content .markdown .footnote-ref{font-size:.7em}div.main .content .navigation{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:column;-moz-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;padding:2em}div.main .content .navigation div{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:row;-moz-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;margin-top:1em}div.main .content .navigation .icon{width:16px;height:16px}div.main .content .navigation a{width:250px;margin:0 1em;text-align:center;font-style:italic;color:#313537}div.main .content .share,div.main .content .share div{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:row;-moz-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;justify-content:center}div.main .content .share{background-color:rgba(152,152,152,7%);padding:1em 0}div.main .content .share a{margin:0 6px}kbd{padding:.1em .6em;border:1px solid #ccc;font-size:11px;font-family:Arial,Helvetica,sans-serif;background-color:#f7f7f7;color:#333;-moz-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 2px #ffffff inset;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 2px #ffffff inset;box-shadow:0 1px rgba(0,0,0,.2),0 0 0 2px #ffffff inset;-moz-border-radius:3px;-webkit-border-radius:3px;border-radius:3px;display:inline-block;margin:0 .1em;text-shadow:0 1px 0 #fff;line-height:1.4;white-space:nowrap}.wf-raleway-n4-active body,.wf-raleway-n4-active div.header nav ul a,.wf-raleway-n7-active div.main .content .page-heading,.wf-raleway-n2-active div.main .container.f04 .content .num,.wf-raleway-n7-active div.main .content .markdown h1,.wf-raleway-n7-active div.main .content .markdown h2,.wf-raleway-n7-active div.main .content .markdown h3,.wf-raleway-n7-active div.main .content .markdown h4,.wf-raleway-n7-active div.main .content .markdown h5,.wf-raleway-n7-active div.main .content .markdown h6{font-family:raleway}.wf-merriweather-n3-active div.main .content .markdown{font-family:merriweather}.wf-ubuntu-mono-n4-active div.main .content .markdown code,.wf-ubuntu-mono-n4-active div.main .content .markdown pre{font-family:ubuntu mono}</style><style media="(min-width: 600px)">body{-webkit-justify-content:center;-moz-justify-content:center;-ms-justify-content:center;justify-content:center}.non-narrow.zero-top-spacing{padding-top:0!important}section{padding:0 16px;margin-left:100px;margin-right:100px;max-width:750px}div.column{padding:0 16px;max-width:750px}div.header{background-color:transparent}div.header .container{-webkit-justify-content:flex-start;-moz-justify-content:flex-start;-ms-justify-content:flex-start;justify-content:flex-start}div.header .container .logo{margin:0}div.header-home .container .logo{max-width:216px;margin-left:24px}div.header-home .name-home{padding-top:30px;font-size:40px}div.header-home nav ul a{font-size:18px}div.header .content{-webkit-align-items:flex-start;-moz-align-items:flex-start;-ms-align-items:flex-start;align-items:flex-start}div.header .name{color:#333}div.header nav{font-size:14px;margin-bottom:0}div.header nav ul{text-align:left}div.header nav ul a{color:#666}div.header nav ul a:hover{color:#333}div.footer{background-color:transparent}div.footer .container{flex-direction:row}div.footer .container a{margin-left:3px;margin-right:3px;color:#666}div.footer .container a:hover{color:#333}div.footer .container a .icon{font-size:18px}div.footer .container a .icon.larger{font-size:20px}div.main .content .front-matter .date,div.main .content .front-matter .author,div.main .content .front-matter .tags,div.main .content .front-matter .word-count,div.main .content .front-matter .middot:before{display:initial}div.main .container.f04{-webkit-justify-content:flex-start;-moz-justify-content:flex-start;-ms-justify-content:flex-start;justify-content:flex-start}div.main .container.f04 .content{-webkit-align-items:flex-start;-moz-align-items:flex-start;-ms-align-items:flex-start;align-items:flex-start}div.main .container.f04 .content .num{margin:0 0 10px;font-size:32px}div.main .container.f04 .content .detail{margin-bottom:30px}.container{padding:0 30px}div.header{padding-top:60px;padding-bottom:60px}div.footer{padding-top:60px;padding-bottom:60px}div.main{padding-top:0}div.main .content{font-size:16px}div.main .container .content .post-item{display:flex;list-style:none;padding-left:1.5em}div.main .container .content .post-item .meta{display:block}div.main .content .markdown blockquote{padding-right:5rem;padding-left:1.25rem}div.main .content .navigation{-webkit-flex-direction:row;-moz-flex-direction:row;-ms-flex-direction:row;flex-direction:row}div.main .content .navigation div{margin-top:0}</style><style media="(min-width: 769px)">div.main .content .markdown figure{width:110%;margin-left:-4%}div.main .content .markdown img{max-width:110%;width:110%;margin-left:-4%}div.main .content .markdown pre{width:110%;margin-left:-4%}</style><noscript><link href="https://fonts.googleapis.com/css?family=Raleway:400,600,700" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Merriweather:300,300i,700,700i" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700" rel=stylesheet></noscript><style type=text/css media=screen>.hljs{display:block;background:#fff;padding:.5em;color:#333;overflow-x:auto}.hljs-comment,.hljs-meta{color:#969896}.hljs-string,.hljs-variable,.hljs-template-variable,.hljs-strong,.hljs-emphasis,.hljs-quote{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#a71d5d}.hljs-literal,.hljs-symbol,.hljs-bullet,.hljs-attribute{color:#0086b3}.hljs-section,.hljs-name{color:#63a35c}.hljs-tag{color:#333}.hljs-title,.hljs-attr,.hljs-selector-id,.hljs-selector-class,.hljs-selector-attr,.hljs-selector-pseudo{color:#795da3}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}</style><link rel=stylesheet href=/css/override.css><link rel="shortcut icon" href=/img/leaf.ico><link href=https://harrigan.xyz/index.xml rel=alternate type=application/rss+xml title="David Harrigan"></head><body><div class="header column"><div class=container><a href=https://harrigan.xyz/><img class=logo src=/img/me.png alt=logo></a><div class=content><a href=/><div class=name><h1>David Harrigan</h1></div></a><nav><ul><li><a href=/blog/>Blog</a></li></ul></nav></div></div></div><div class="main post non-narrow zero-top-spacing column"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Testing Go gRPC Server Using an in-memory Buffer with `bufconn`</div></div><div class=meta><div class=date title="Fri Jan 17 2020 00:00:00 UTC">Jan 17, 2020</div><div class="reading-time middot">3 minute read</div><div class=tags><ul><li class=middot><a href=/tags/go>go</a></li><li class=middot><a href=/tags/golang>golang</a></li><li class=middot><a href=/tags/development>development</a></li><li class=middot><a href=/tags/testing>testing</a></li></ul></div><div class=tags><ul></ul></div></div></div><div class=markdown><p>It can be cumbersome to setup a testing environment targeting a live server
to implement full API testing against your gRPC server. Even spinning up a
server from your test file can lead to unintended consequences that require
you to allocate a TCP port (parallel runs, multiple runs under same CI
server).</p><p><a href=https://godoc.org/google.golang.org/grpc/test/bufconn>bufconn</a> is a package
which provides a <code>Listener</code> object that implements <code>net.Conn</code>. We can
substitute this listener in a gRPC server - allowing us to spin up a server
that acts as a full-fledged server that can be used for testing that talks
over an in-memory buffer instead of a real port.</p><h2 id=goals>Goals</h2><ul><li>Spin up a gRPC server using an in-memory buffer</li><li>Use the server in a standard <code>testing.Test</code> test function</li></ul><h2 id=setup>Setup</h2><p>Same as my other post, I created a simple gRPC service that implements <code>Ping</code>
and <code>StreamPring</code>. Calling <code>Ping</code> replies with (you guessed it!) a
<code>pong</code> message. <code>StreamPing</code> is similar, but you can specify how many times
it <code>pong</code>&rsquo;s back.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>ping</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;protos&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>Pinger</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>Ping</span><span class=p>(</span><span class=n>PingRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>PingResponse</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>PingStream</span> <span class=p>(</span><span class=n>PingRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>stream</span> <span class=n>PingResponse</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>PingRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>int32</span> <span class=n>count</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>PingResponse</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>bytes</span> <span class=n>payload</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><h2 id=using-bufconn>Using <code>bufconn</code></h2><p>To easily spin up a server and a client that talk over a <code>bufconn</code> buffer,
I created a function that is called by the test file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>server</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>(</span><span class=nx>pb</span><span class=p>.</span><span class=nx>PingerClient</span><span class=p>,</span> <span class=kd>func</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>buffer</span> <span class=o>:=</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span>
</span></span><span class=line><span class=cl>	<span class=nx>listener</span> <span class=o>:=</span> <span class=nx>bufconn</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=nx>buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterPingerServer</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>Pinger</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>listener</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>DialContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithContextDialer</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>listener</span><span class=p>.</span><span class=nf>Dial</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}),</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>closer</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>listener</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewPingerClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>client</span><span class=p>,</span> <span class=nx>closer</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Important thing to note here are, this function:</p><ul><li>Spins up gRPC server using the bufconn buffer</li><li>Creates a client that talks over the buffer using <code>gRPC.WithContextDialer</code></li><li>Returns function to terminate the listener and the server</li></ul><h2 id=using-the-bufconn-client>Using the <code>bufconn</code> client</h2><p>With the above function, the rest are easy:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>assert</span> <span class=o>:=</span> <span class=nx>assert</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>client</span><span class=p>,</span> <span class=nx>closer</span> <span class=o>:=</span> <span class=nf>server</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>defer</span> <span class=nf>closer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>out</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Ping</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>tc</span><span class=p>.</span><span class=nx>in</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>assert</span><span class=p>.</span><span class=nf>Nil</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>tc</span><span class=p>.</span><span class=nx>expected</span><span class=p>.</span><span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>Nil</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>tc</span><span class=p>.</span><span class=nx>expected</span><span class=p>.</span><span class=nx>out</span><span class=p>,</span> <span class=nx>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>Nil</span><span class=p>(</span><span class=nx>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>tc</span><span class=p>.</span><span class=nx>expected</span><span class=p>.</span><span class=nx>err</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>That is the meat of my test. It uses the <code>server</code> function, after making sure
the <code>closer</code> is defered, it uses the client to make a request. The response
is asserted against expectation. This all happens against a gRPC server,
except it uses <code>bufconn</code> instead of a TCP socket.</p><p>Source code for the full setup is available
<a href=https://github.com/davidharrigan/bufconn-test>here</a>.</p><h3 id=conclusion>Conclusion</h3><p><code>bufconn</code> allows you to spin up a gRPC server that talk over an in-memory
buffer. Tests are fast and reliable, and allows you to easily setup
integration style tests that uses a full server.</p></div><br><div class=navigation><div><img class=icon src=/img/back.svg alt=back>
<a href=https://harrigan.xyz/blog/integration-testing-with-golang/>Integration Testing with Golang</a></div><div style=width:100%></div></div><br><div class=disqus><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//harrigan-xyz.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><div class="footer column"><div class=container><div class=copyright><a href=https://harrigan.xyz/license>Copyright © 2018-2022 David Harrigan</a></div><div class=icons><a href=https://www.instagram.com/david.harrigan rel=me target=_blank><img class=icon src=https://harrigan.xyz/img/instagram.svg alt=instagram></a>
<a href=https://github.com/davidharrigan rel=me target=_blank><img class=icon src=https://harrigan.xyz/img/github.svg alt=github></a>
<a href=https://twitter.com/DavidTHarrigan rel=me target=_blank><img class=icon src=https://harrigan.xyz/img/twitter.svg alt=twitter></a>
<a href=https://www.linkedin.com/in/david-t-harrigan rel=me target=_blank><img class=icon src=https://harrigan.xyz/img/linkedin.svg alt=linkedin></a>
<a href=mailto:dave.t.harrigan@gmail.com><img class=icon src=https://harrigan.xyz/img/email.svg alt=email></a>
<a href=https://harrigan.xyz/index.xml><img class=icon src=https://harrigan.xyz/img/rss.svg alt=rss></a></div></div></div><script src=https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js></script>
<script>WebFont.load({google:{families:["Raleway:400,600,700","Merriweather:300,300i,700,700i","Ubuntu+Mono:400,700"]}})</script><script src=https://harrigan.xyz/js/highlight.min.js defer></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/go.min.js defer></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/python.min.js defer></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/protobuf.min.js defer></script>
<script>window.onload=function(){hljs.initHighlighting()}</script></body></html>